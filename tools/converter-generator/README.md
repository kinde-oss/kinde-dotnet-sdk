# Converter Generator

Stable converter generator for Kinde .NET SDK that generates Newtonsoft.Json converters for C# models with Option<> properties.

## Features

- ✅ **Type-safe**: Full type hints and dataclasses
- ✅ **Template-based**: Jinja2 templates for maintainable code generation
- ✅ **Configuration**: YAML config file support
- ✅ **Comprehensive**: Handles all property types (string, enum, List<>, Dictionary<>, Object)
- ✅ **Robust**: C# reserved keyword escaping, nested generics support
- ✅ **Tested**: Unit tests based on production requirements
- ✅ **Stable**: Proven parsing logic with better structure

## Setup

1. **Create virtual environment:**
   ```bash
   cd tools/converter-generator
   ./setup-venv.sh
   source venv/bin/activate
   ```

2. **Install dependencies:**
   ```bash
   pip install -r requirements.txt
   ```

## Usage

### Generate Converters for Kinde.Api

```bash
cd tools/converter-generator
python generate_converters.py --config config-kind-api.yaml
```

This will:
1. Generate all converters for models in `Kinde.Api/Model`
2. Automatically update `Kinde.Api/Client/ApiClient.cs` with converter registrations

### Generate Converters for Kinde.Accounts

```bash
cd tools/converter-generator
python generate_converters.py --config config-accounts-api.yaml
```

### Disable ApiClient.cs Update

If you don't want to automatically update `ApiClient.cs`:

```bash
python generate_converters.py --config config-kind-api.yaml --no-update-api-client
```

### Specify Custom ApiClient.cs Path

```bash
python generate_converters.py --config config-kind-api.yaml --api-client Kinde.Api/Client/ApiClient.cs
```

### With Validation

```bash
python generate_converters.py --config config-kind-api.yaml --validate
```

### With Verbose Output

```bash
python generate_converters.py --config config-kind-api.yaml --verbose
```

### Custom Directories

```bash
python generate_converters.py \
  --model-dir ../../Kinde.Api/Model \
  --converter-dir ../../Kinde.Api/Converters \
  --config config-kind-api.yaml
```

## Configuration Files

- `config-kind-api.yaml` - Configuration for Kinde.Api (Management API)
- `config-accounts-api.yaml` - Configuration for Kinde.Accounts (Accounts API)

Each config file specifies:
- Models to exclude from generation
- Model and converter directories (relative to project root)
- Validation settings
- Generation settings

## Testing

Run unit tests:

```bash
# All tests
pytest tests/ -v

# Specific test file
pytest tests/test_parser.py -v

# With coverage
pytest tests/ --cov=generate_converters --cov-report=html
```

## Manually Maintained Converters

The following converters are manually maintained and should NOT be regenerated:

- `CustomEnumConverter.cs` - Generic enum converters used across all models

These are excluded in the config files and will be skipped during generation.

## Generated Converters

All converters in the specified converter directories (except manually maintained ones) are generated by this script. They can be safely regenerated at any time.

## Requirements

- Python 3.11+
- Virtual environment (venv)
- Dependencies from `requirements.txt`

## Architecture

- **Parser** (`CSharpModelParser`): Extracts properties from C# model files
- **Generator** (`ConverterGenerator`): Generates C# converter code using Jinja2 templates
- **Validator** (`ConverterValidator`): Validates generated converter structure
- **ApiClientUpdater** (`api_client_updater.py`): Automatically updates `ApiClient.cs` with converter registrations
- **CLI** (`main`): Command-line interface using Click

## Automatic ApiClient.cs Updates

The generator automatically updates `ApiClient.cs` to register all generated converters. This ensures:

- ✅ New converters are automatically registered
- ✅ No manual editing of `ApiClient.cs` required
- ✅ Converter list stays in sync with generated files
- ✅ Proper categorization (Request, Response, Inner, manually maintained)

The updater:
1. Scans the converter directory for all `*NewtonsoftConverter.cs` files
2. Categorizes them (Request, Response, Inner, manually maintained)
3. Updates the `CreateStandardConverters()` method in `ApiClient.cs`
4. Preserves comments and structure

## Production Requirements

The generator is tested against production Kinde requirements:

1. ✅ Must extract Option<> properties correctly
2. ✅ Must extract required (non-Option) parameters
3. ✅ Must handle nested generics (List<>, Dictionary<>)
4. ✅ Must escape C# reserved keywords
5. ✅ Must find JSON property names from [JsonPropertyName] attributes
6. ✅ Must handle nullable types correctly
7. ✅ Must generate valid C# code that compiles
8. ✅ Must use PascalCase for property access in WriteJson
9. ✅ Must use camelCase for constructor parameters in ReadJson
10. ✅ Must preserve JSON property names (snake_case)

