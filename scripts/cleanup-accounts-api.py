#!/usr/bin/env python3
"""
Clean up Accounts API files by removing auto-generated markers and improving structure.
"""

import os
import re
import sys
from pathlib import Path

def remove_auto_generated_header(content: str) -> str:
    """Remove auto-generated header comments"""
    # Remove <auto-generated> comment
    content = re.sub(r'^//\s*<auto-generated>\s*\n', '', content, flags=re.MULTILINE)
    
    # Remove OpenAPI generator header block
    pattern = r'/\*\s*\n\s*\* Kinde Account API.*?\* Generated by:.*?\*/\s*\n'
    content = re.sub(pattern, '', content, flags=re.DOTALL | re.MULTILINE)
    
    # Remove standalone auto-generated comments
    content = re.sub(r'^\s*//\s*<auto-generated>.*?\n', '', content, flags=re.MULTILINE)
    
    return content

def clean_file(file_path: Path) -> bool:
    """Clean a single file"""
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        original_content = content
        
        # Remove auto-generated headers
        content = remove_auto_generated_header(content)
        
        # Only write if content changed
        if content != original_content:
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(content)
            return True
        return False
    except Exception as e:
        print(f"Error processing {file_path}: {e}", file=sys.stderr)
        return False

def main():
    """Main entry point"""
    if len(sys.argv) < 2:
        print("Usage: cleanup-accounts-api.py <accounts-api-dir>")
        sys.exit(1)
    
    accounts_dir = Path(sys.argv[1])
    
    if not accounts_dir.exists():
        print(f"Error: Directory not found: {accounts_dir}")
        sys.exit(1)
    
    # Find all C# files
    cs_files = list(accounts_dir.rglob("*.cs"))
    
    print(f"Found {len(cs_files)} C# files to process...")
    
    cleaned_count = 0
    for cs_file in cs_files:
        if clean_file(cs_file):
            cleaned_count += 1
            print(f"Cleaned: {cs_file.relative_to(accounts_dir)}")
    
    print(f"\nCleaned {cleaned_count} files")

if __name__ == '__main__':
    main()

